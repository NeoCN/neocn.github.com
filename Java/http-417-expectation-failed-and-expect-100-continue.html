
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>HTTP 417 Expectation Failed与Expect:100-Continue - DevX.Me</title>
  <meta name="author" content="小马">

  
  <meta name="description" content="这两天写代码，调用新浪微博的Rest API，使用HttpClient 4.0，以Post方式提交，请求参数以UrlEncodedFormEntity的形式设置到HttpPost对象中，提交到API时，出现如下异常：
&lt;?xml version="1.0" encoding="utf-8 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://NeoCN.github.com/Java/http-417-expectation-failed-and-expect-100-continue.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="DevX.Me" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-19855289-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DevX.Me</a></h1>
  
    <h2>My Coding Life!</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">HTTP 417 Expectation Failed与Expect:100-Continue</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-21T00:00:00+08:00" pubdate data-updated="true">Jul 21<span>st</span>, 2010</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>这两天写代码，调用新浪微博的Rest API，使用HttpClient 4.0，以Post方式提交，请求参数以UrlEncodedFormEntity的形式设置到HttpPost对象中，提交到API时，出现如下异常：
<pre lang="xml" escape="true">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;417 Expectation Failed&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Error 417 Expectation Failed&lt;/h1&gt;
        &lt;p&gt;Expectation Failed&lt;/p&gt;
        &lt;h3&gt;Guru Meditation:&lt;/h3&gt;
        &lt;p&gt;XID: 2734998565&lt;/p&gt;
        &lt;address&gt;
            &lt;a href="http://www.varnish-cache.org/"&gt;Varnish&lt;/a&gt;
        &lt;/address&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
<br />
刚开始有点莫名其妙，这是哪门子错误，没见过啊，于是去查HTTP状态字定义，得到如下描述：
<pre>
The expectation given in an Expect request-header field (see section 
14.20) could not be met by this server, or, if the server is a proxy,    
the server has unambiguous evidence that the request could not be met    
by the next-hop server.
</pre>
大致的意思是：
<pre>服务器不支持Expect请求头部域，或者，如果服务器是代理服务器的话，
服务器有明确的证据表明请求不能到达下一跳服务器。</pre>
<br />
那，到底什么是Expect请求头部域呢？以前完全没用过，也很少见，跟踪浏览器的HTTP请求的时候也很少见这个头部域，继续查吧，根据HTTP请求头部Expect域的定义，得到如下信息：
<pre>The Expect request-header field is used to indicate that particular
server behaviors are required by the client.
      Expect       =  "Expect" ":" 1#expectation
      expectation  =  "100-continue" | expectation-extension
      expectation-extension =  token [ "=" ( token | quoted-string )
                               *expect-params ]
      expect-params =  ";" token [ "=" ( token | quoted-string ) ]
A server that does not understand or is unable to comply with any of 
the expectation values in the Expect field of a request MUST respond
 with appropriate error status. The server MUST respond with a 
417(Expectation Failed) status if any of the expectations cannot be met 
or, if there are other problems with the request, some other 4xx status.
This header field is defined with extensible syntax to allow for 
future extensions. If a server receives a request containing an 
Expect field that includes an expectation-extension that it does not 
support, it MUST respond with a 417 (Expectation Failed) status.
Comparison of expectation values is case-insensitive for unquoted 
tokens (including the 100-continue token), and is case-sensitive for 
quoted-string expectation-extensions.
The Expect mechanism is hop-by-hop: that is, an HTTP/1.1 proxy MUST 
return a 417 (Expectation Failed) status if it receives a request 
with an expectation that it cannot meet. However, the Expect 
request-header itself is end-to-end; it MUST be forwarded if the 
request is forwarded.
Many older HTTP/1.0 and HTTP/1.1 applications do not understand the   
Expect header.</pre>
大致意思如下：
<pre>Expect请求头部域，用于指出客户端要求的特殊服务器行为。若服务器不能理解或者满足
Expect域中的任何期望值，则必须返回417(Expectation Failed)状态，或者如果请求
有其他问题，返回4xx状态。
这个头部域使用可扩展语法定义，以方便将来扩展。如果服务器收到包含Expect头部域的
请求且包含一个它不支持的期望值扩展，则必须返回417(Expectation Failed)状态。
期望值的比较，对于非引用符号(包括100-continue)是大小写无关的，对于引用字符串
的期望值扩展，则是大小写敏感的。
Expect域的机制是逐跳进行的，也就是说如果一个代理服务器收到包含不能满足的期望
的请求时，必须返回417(Expectation Failed)状态。而Expect请求头部域自身，
却是端到端的，如果请求被转发，则它也必须被转发。
很多旧的HTTP/1.0和HTTP/1.1应用不支持Expect头部。
</pre>
到这里，基本明白了为什么会出现这样的错误，说明代码最后生成的HTTP请求，包含了服务器不能处理的Expect头部，到底是什么？装上Wireshark，监听一下请求内容，发现出现异常时的请求中的Expect头部是这样的：<strong>Expect:100-Continue</strong>，难道是它引起的？继续查……
<br />
对于Expect:100-Continue，HttpClient的官方文档是这样描述的：
<pre>
The purpose of the Expect: 100-Continue handshake is to allow the client that 
is sending a request message with a request body to determine if the origin 
server is willing to accept the request (based on the request headers) before
 the client sends the request body.
Expect: 100-continue handshake should be used with caution, as it may cause
problems with HTTP servers and proxies that do not support HTTP/1.1 protocol.
</pre>
大意如下：
<pre>
Expect:100-Continue握手的目的，是为了允许客户端在发送请求内容之前，判断源服务器是否愿意接受
请求（基于请求头部）。
Expect:100-Continue握手需谨慎使用，因为遇到不支持HTTP/1.1协议的服务器或者代理时会引起问题。
</pre>
<br />
而HttpClient 4.0中，是否激活Expect:100-Continue，是由HTTP请求执行参数<strong>http.protocol.expect-continue</strong>来控制的，通过设置参数值为true或者false，可以相应的激活或者关闭Expect:100-Continue握手。注意，在HttpClient中，默认是激活的。<br />
HttpClient 4 中关闭Expect:100-Continue握手的代码如下：
<pre lang="java">
HttpPost httpPost = new HttpPost(url);
httpPost.getParams().setBooleanParameter(CoreProtocolPNames.USE_EXPECT_CONTINUE,
false);
</pre>
关闭HttpClient中的Expect:100-Continue握手之后，再执行程序，顺利地通过微博API发出了一条消息。
<br />
总结：通过这次的问题解决，可以看出，对于HTTP协议不够熟悉，底层了解不够，同时没有认真阅读HttpClient开发文档。我想，现在从事软件开发行业的大部分人都或多或少有这样的问题，即忽视底层协议及原理的学习。真正的了解底层原理，借以开源代码及开发文档的辅助，这样才会能够实现快速、高效、稳定的程序开发。
<br />
<strong>参考文献：</strong>
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.1.1" target="_blank">100 Continue</a>
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.2.3" target="_blank">Use of the 100 (Continue) Status</a>
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.20" target="_blank">Expect Header Field Definition</a>
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.18" target="_blank">417 Expectation Failed</a>
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html" target="_blank">Hypertext Transfer Protocol &#8211; HTTP/1.1 </a>
<a href="http://hc.apache.org/httpcomponents-client-4.0.1/tutorial/html/fundamentals.html" target="_blank">HttpClient Tutorial &#8211; 1. Fundamentals </a></p>

<p></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">小马</span></span>

      








  


<time datetime="2010-07-21T00:00:00+08:00" pubdate data-updated="true">Jul 21<span>st</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='//categories/java/'>Java</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/Java/java-4-ever.html" title="Previous Post: Java 4-Ever">&laquo; Java 4-Ever</a>
      
      
        <a class="basic-alignment right" href="/Java/google-has-acquired-instantiations.html" title="Next Post: Google收购Instantiations">Google收购Instantiations &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/其他/4-traps-a-startup-should-care.html">[转]4个造成创业失败的最重要陷阱</a>
      </li>
    
      <li class="post">
        <a href="/其他/twelve-principles-of-agile-software.html">敏捷软件的十二条原则</a>
      </li>
    
      <li class="post">
        <a href="/其他/stay-hungry-stay-foolish.html">Stay Hungry. Stay Foolish.</a>
      </li>
    
      <li class="post">
        <a href="/其他/how-to-start-a-startup.html">如何进行成功的创业</a>
      </li>
    
      <li class="post">
        <a href="/Android/hierarchyviewer-bat-is-missing-from-android-sdk_r07-windows.html">Windows版本的Android SDK R07中缺少hierarchyviewer.bat文件</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - 小马 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'devx_me';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://NeoCN.github.com/Java/http-417-expectation-failed-and-expect-100-continue.html';
        var disqus_url = 'http://NeoCN.github.com/Java/http-417-expectation-failed-and-expect-100-continue.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
